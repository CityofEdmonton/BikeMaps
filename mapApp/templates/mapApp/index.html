{% extends "mapApp/base.html" %}

{% block title %}BikeMaps{% endblock %}

<!-- HEAD STUFF -->
{% load staticfiles crispy_forms_tags geojson_tags %}
{% block headerCSS %}
    <!-- Load leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />

    <!-- Load marker clustering -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.css">

    <!-- Load draw pluging -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.css">

    <!-- Leaflet Geocoder -->
    <link rel="stylesheet" href="{% static 'leaflet/plugins/leaflet-control-geocoder/Control.Geocoder.css' %}">

    <!-- Local styles -->
    <link rel="stylesheet" href="{% static 'mapApp/css/index.css' %}">
{% endblock %}

{% block headerJS %}
    <!-- LOAD JS -->
    <!-- Load leaflet -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>

    <!-- Load marker clustering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/leaflet.markercluster.js"></script>

    <!-- Load Maki Markers Icons -->
    <script src="{% static 'leaflet/plugins/maki-markers/Leaflet.MakiMarkers.js' %}"></script>

    <!-- Load heatmap -->
    <script src="{% static 'leaflet/plugins/leaflet-heat/leaflet-heat.js' %}"></script>

    {% if not request.mobile %}
    <!-- Load draw pluging -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.js"></script>
    <!-- // <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw-src.js"></script> -->

    {% endif %}

    <!-- Used for pie chart creation -->
    <!-- d3 v3.4.8 -->
    <script src="{% static 'd3/d3.min.js' %}" charset="utf-8"></script>

    <!-- Leaflet Geocoder -->
    <script src="{% static 'leaflet/plugins/leaflet-control-geocoder/Control.Geocoder.js' %}"></script>

    <!-- Tooltips script -->
    <script src="{% static 'mapApp/js/tooltips.js' %}"></script>

    <!-- GeoJSON sources -->
    <script src="{% static 'mapApp/data/policeData.js' %}"></script>
    <script src="{% static 'mapApp/data/icbcData.js' %}"></script>

    <!-- Load icon definitions -->
    <script src="{% static 'mapApp/js/icons.js' %}"></script>

    <!-- Load app js -->
    <script src="{% static 'mapApp/js/map.js' %}"></script>
{% endblock %}

<!-- BODY -->
{% block body %}
    {% crispy geofenceForm %}
    {% include 'mapApp/incident_form.html' %}

    <!-- Leaflet map -->
    <div id="map"></div>

    <!-- JS to control message display and feature creation -->
    <script>
        // Show modals if there are from errors
        {% if incidentForm.errors %}
        $(window).load(function(){
            $('#incidentForm').modal('show');
        });
        {% elif hazardForm.errors %}
        $(window).load(function(){
            $('.nav-tabs a[href="#hazardReport"]').tab('show')
            $('#incidentForm').modal('show');
        });
        {% elif theftForm.errors %}
        $(window).load(function(){
            $('.nav-tabs a[href="#theftReport"]').tab('show')
            $('#incidentForm').modal('show');
        });
        {% elif geofenceForm.errors %}
        $(window).load(function(){
            $('#geofenceForm').modal('show');
        });
        {% endif %}

        $(document).ready(function(){
          // Add all geojson auxiliary data
          initializeGeoJSON();

          // Initialize the map
          initialize(scrollZoom=true {% if request.mobile %}, mobile=true {% endif %});

          // Load user alert areas from the database
          {% for polygon in geofences %}
              getPolygon( {{ polygon.latlngList }}, {{ polygon.pk }} );
          {% endfor %}

          // Load user points from the database
          var collisions = geojsonMakiMarker({{ collisions|geojsonfeature:"incident,incident_type,incident_with,incident_date"|safe }}, "collision").addTo(incidentData);
          var nearmisses = geojsonMakiMarker({{ nearmisses|geojsonfeature:"incident,incident_type,incident_with,incident_date"|safe }}, "nearmiss").addTo(incidentData);
          var hazards = geojsonMakiMarker({{ hazards|geojsonfeature:"hazard,hazard_date"|safe }}, "hazard").addTo(incidentData);
          var thefts = geojsonMakiMarker({{ thefts|geojsonfeature:"theft,theft_date"|safe }}, "theft").addTo(incidentData);


          addControls(mobile={% if request.mobile %}true{% else %}false{% endif %});

          // Set the appropriate map extend and zoom
          setView({% if zoom %} {{ lat }}, {{ lng }}, {{ zoom}} {% endif %});
        });

        // Display number of points in user dropdown if admin is logged in
        {% if request.user.is_administrator %}
            $(".user-menu").append('<li role="presentation" class="divider"></li>');
            $(".user-menu").append('<li role="presentation" class="dropdown-header">Points submitted</li>');
            $(".user-menu").append('<li><a href="#"><small>Collisions: {{collisions|length}}</small></a></li>');
            $(".user-menu").append('<li><a href="#"><small>Near misses: {{nearmisses|length}}</small></a></li>');
            $(".user-menu").append('<li><a href="#"><small>Hazards: {{hazards|length}}</small></a></li>');
            $(".user-menu").append('<li><a href="#"><small>Thefts: {{thefts|length}}</small></a></li>');

            var total = {{thefts|length}}+{{hazards|length}}+{{collisions|length}}+{{nearmisses|length}}
            $(".user-menu").append('<li><a href="#"><small>Total: '+total+'</small></a></li>');
        {% endif %}

    </script>

    <!-- Add modal help html -->
    {% include 'mapApp/util/tips.html' %}

    <!-- Add draw controls and actions -->
    {% include 'mapApp/util/draw.html' %}

    <!-- TODO add mobile controls to record paths or take pictures etc. -->
{% endblock %}
