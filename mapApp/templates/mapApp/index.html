<!DOCTYPE html>
<html>
<head>
    {% include 'mapApp/header.html' %}

    {% load staticfiles %}

    <!-- Load leaflet -->
    <link rel="stylesheet" href="{% static 'leaflet/leaflet.css' %}"/>
    <script src="{% static 'leaflet/leaflet.js' %}"></script>

    <!-- Load the custom icon library -->
    <script src="{% static 'leaflet/plugins/markers/maki/Leaflet.MakiMarkers.js' %}"></script>

    <!-- Load marker clustering -->
    <link rel="stylesheet" href="{% static 'leaflet/plugins/layer/markercluster/MarkerCluster.css' %}" />
    <link rel="stylesheet" href="{% static 'leaflet/plugins/layer/markercluster/MarkerCluster.Default.css' %}" />
    <script src="{% static 'leaflet/plugins/layer/markercluster/leaflet.markercluster-src.js' %}"></script>
    
    <!-- Load heatmap -->
    <script src="{% static 'leaflet/plugins/layer/heat/leaflet-heat.js' %}"></script>

    <!-- Load draw pluging -->
    <link rel="stylesheet" href="{% static 'leaflet/plugins/layer/draw/dist/leaflet.draw.css' %}" />
    <script src="{% static 'leaflet/plugins/layer/draw/src/Leaflet.draw.js' %}"></script>

    <script src="{% static 'leaflet/plugins/layer/draw/src/edit/handler/Edit.Poly.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/edit/handler/Edit.SimpleShape.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/edit/handler/Edit.Circle.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/edit/handler/Edit.Rectangle.js' %}"></script>

    <script src="{% static 'leaflet/plugins/layer/draw/src/draw/handler/Draw.Feature.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/draw/handler/Draw.Polyline.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/draw/handler/Draw.Polygon.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/draw/handler/Draw.SimpleShape.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/draw/handler/Draw.Rectangle.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/draw/handler/Draw.Circle.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/draw/handler/Draw.Marker.js' %}"></script>

    <script src="{% static 'leaflet/plugins/layer/draw/src/ext/LatLngUtil.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/ext/GeometryUtil.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/ext/LineUtil.Intersect.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/ext/Polyline.Intersect.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/ext/Polygon.Intersect.js' %}"></script>

    <script src="{% static 'leaflet/plugins/layer/draw/src/Control.Draw.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/Tooltip.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/Toolbar.js' %}"></script>

    <script src="{% static 'leaflet/plugins/layer/draw/src/draw/DrawToolbar.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/edit/EditToolbar.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/edit/handler/EditToolbar.Edit.js' %}"></script>
    <script src="{% static 'leaflet/plugins/layer/draw/src/edit/handler/EditToolbar.Delete.js' %}"></script>


    <!-- GeoJSON sources -->
    <script type="text/javascript" src="{% static 'mapApp/data/policeData.js' %}"></script> 
    <script type="text/javascript" src="{% static 'mapApp/data/bikeRoutes.js' %}"></script>
    


    <!-- Load app js -->
    <script src="{% static 'mapApp/js/map.js' %}"></script>

</head>

<body>
    <!-- Tag to include nav_bar.html code with index template -->
    {% include 'mapApp/nav_bar.html' %}

    <!-- Modal form popup -->
    {% include 'mapApp/incident_form.html' %}

    <!-- Leaflet map --> 
    <div id="map"></div>

    <!-- Load user points from the database -->
    {% for incident in incidents %}
        <script type="text/javascript">
            var latlng = [ {{ incident.point.coords.1 }}, {{ incident.point.coords.0 }} ];
            var msg = "<b>{{ incident.incident_type }}</b><br>{{ incident.incident_date }}.";
            getPoint( latlng, msg, "{{incident.incident_type}}" );
        </script>
    {% endfor %}


    <script type="text/javascript">
        // Create the map
        initialize();

        // Enable click to add point
        // map.on('click', setPoint);

        map.on('draw:created', function (e) {
            var type = e.layerType,
                layer = e.layer;
                // console.log(layer.getLatLng().lat);
            if (type === 'marker') {
                document.getElementById("point").value = ('Point(' + layer.getLatLng().lng + ' ' + layer.getLatLng().lat + ')');               
                $('#incidentForm').modal('show');
            }

        });
        
        // Show the modal if there are errors in a form submit
        {% if formErrors %}
        $(window).load(function(){
            $('#incidentForm').modal('show');
        });
        {% endif %}

    </script>

</body>
</html>