<!DOCTYPE html>
<html>
    <head>
        {% include 'mapApp/header.html' %}
        
        {% load staticfiles %}

        <!-- Load leaflet -->
        <link rel="stylesheet" href="{% static 'leaflet/leaflet.css' %}"/>
        <script src="{% static 'leaflet/leaflet.js' %}"></script>

        <!-- Load the custom icon library -->
        <script src="{% static 'leaflet/plugins/markers/maki/Leaflet.MakiMarkers.js' %}"></script>

        <!-- Load marker clustering -->
        <link rel="stylesheet" href="{% static 'leaflet/plugins/layer/markercluster/MarkerCluster.css' %}" />
        <link rel="stylesheet" href="{% static 'leaflet/plugins/layer/markercluster/MarkerCluster.Default.css' %}" />
        <script src="{% static 'leaflet/plugins/layer/markercluster/leaflet.markercluster-src.js' %}"></script>
    
        <!-- Load heatmap -->
        <script src="{% static 'leaflet/plugins/layer/heat/leaflet-heat.js' %}"></script>

        <!-- Load shapefile plugin -->
        <script src="{% static 'leaflet/plugins/layer/shapefile/shp.js' %}"></script>
        <script src="{% static 'leaflet/plugins/layer/shapefile/leaflet.shpfile.js' %}"></script>


        <!-- Load app js -->
        <script src="{% static 'mapApp/js/map.js' %}"></script>
    
    </head>


    <body>
        <!-- Tag to include nav_bar.html code with index template -->
        {% include 'mapApp/nav_bar.html' %}
       
        <!-- Modal form popup -->
        {% include 'mapApp/incident_form.html' %}
        
        <!-- Leaflet map --> 
        <div id="map"></div>
     
        <!-- Load user points from the database -->
        {% for incident in incidents %}
            <script>
                var latlng = [ {{ incident.point.coords.1 }}, {{ incident.point.coords.0 }} ];
                var msg = "<b>{{ incident.incident_type }}</b><br>{{ incident.incident_date }}.";
                addPoint( latlng, msg, "{{incident.incident_type}}" );
            </script>
        {% endfor %}

        <!-- Load police data points from the database -->
        {% for incident in police_data %}
            <script>
                var latlng = [ {{ incident.point.coords.1 }}, {{ incident.point.coords.0 }} ];
                var msg = "<b>{{ incident.on_street }}</b><br>{{ incident.acc_date }}.";
                addPoint( latlng, msg, "police" );
            </script>
        {% endfor %}


        <script type="text/javascript">
            // Create the map
            initialize();

            // Enable click to add point
            map.on('click', mapClickPrompt);
            
            // Show the modal if there are errors in a form submit
            {% if formErrors %}
                $(window).load(function(){
                    $('#incidentForm').modal('show');
                });
            {% endif %}


            // Shapefile layer for bike lanes
            var bikeLanes = new L.Shapefile("{% static 'mapApp/data/COVBikeRoutes.zip' %}", {onEachFeature:function(feature, layer) {
                if (feature.properties) {
                    layer.bindPopup(Object.keys(feature.properties).map(function(k){
                        return k + ": " + feature.properties[k] ;
                    }).join("<br />"),{maxHeight:200});
                }
            }});

            bikeLanes.addTo(map);

        </script>

    </body>
</html>