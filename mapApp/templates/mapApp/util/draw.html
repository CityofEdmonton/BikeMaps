{% load staticfiles %}

<!-- Load draw pluging -->
<link rel="stylesheet" href="{% static 'leaflet/plugins/leaflet.draw/dist/leaflet.draw.css' %}">
<script src="{% static 'leaflet/plugins/leaflet.draw/src/Leaflet.draw.js' %}"></script>

<script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/handler/Edit.Poly.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/handler/Edit.SimpleShape.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/handler/Edit.Circle.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/handler/Edit.Rectangle.js' %}"></script>

<script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.Feature.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.Marker.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.Polyline.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.SimpleShape.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.Polygon.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.Rectangle.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.Circle.js' %}"></script>

<script src="{% static 'leaflet/plugins/leaflet.draw/src/ext/LatLngUtil.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/ext/GeometryUtil.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/ext/LineUtil.Intersect.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/ext/Polyline.Intersect.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/ext/Polygon.Intersect.js' %}"></script>

<script src="{% static 'leaflet/plugins/leaflet.draw/src/Control.Draw.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/Tooltip.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/Toolbar.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/DrawToolbar.js' %}"></script>

<script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/EditToolbar.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/handler/EditToolbar.Edit.js' %}"></script>
<script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/handler/EditToolbar.Delete.js' %}"></script> 

<script>
	/* ADD THE CONTROL TO LEAFLET MAP */
    map.addControl(new L.Control.Draw({
    draw: {
        polyline: false,
        rectangle: false,
        circle: false,
        marker: {
            icon:bikeGreyIcon
        },
        {% if request.user.is_authenticated %}
            polygon: {
                allowIntersection: false
            }
        {% else %}
            polygon: false
        {% endif %}
        },

        {% if request.user.is_authenticated %}
        edit: {
            {% if request.user.is_superuser %}
            featureGroup: accidentPoints,           /* CHANGE ME!!!! SHOULD BE ACCIDENTPOINTS AND ALERTAREAS*****/
            {% else %}
            featureGroup: alertAreas,
            {% endif %}
            edit: true,
            remove: true
        },
        {% else %}
        edit: false
        {% endif %}
    }));
    

	/* DRAWING CONTROL TOOLTIPS */
    L.drawLocal.draw.toolbar.buttons.marker = 'Add an incident marker';
    L.drawLocal.draw.handlers.marker.tooltip.start = 'Place me where the incident occurred';
    L.drawLocal.draw.toolbar.buttons.polyline = 'Add a cycling route';
    L.drawLocal.draw.toolbar.buttons.polygon = 'Trace an area to receive incident alerts';
    L.drawLocal.draw.handlers.polygon.tooltip.start = 'Trace the area you want to receive alerts for';


    /* DEFINE ACTIONS TRIGGERED BY NEW DRAWINGS */
    map.on('draw:created', function (e) {
        var type = e.layerType,
            layer = e.layer;
        
        if (type === 'marker') {
            // Set form geometry field to click location
            document.getElementById("point").value = (JSON.stringify(layer.toGeoJSON().geometry));               
            $('#incidentForm').modal('show');
        }
        if (type === 'polyline') {
            // Set form geometry field to click location
            document.getElementById("line").value = (JSON.stringify(layer.toGeoJSON().geometry));               
            $('#routeForm').modal('show');
        }
        if (type === 'polygon') {
            // Set form geometry field to click location
            document.getElementById("geofence").value = (JSON.stringify(layer.toGeoJSON().geometry));                             
            document.getElementById("userEmail").value = ("{{ request.user.email }}");               
            $('#geofenceForm').modal('show');
        }
    });

    map.on('draw:edited', function(e) {
        var layers = e.layers;
        layers.eachLayer(function (layer) {
            console.log("obj edit")

        });
    });

    {% url 'mapApp:about' as about %}
    map.on('draw:deleted', function(e) {
        var layers = e.layers;
        layers.eachLayer(function (layer) {
            console.log("obj delete");

        });
    });




</script>