{% extends "mapApp/base.html" %}
{% load staticfiles %}


{% block title %}
	Monthly statistics
{% endblock %}


{% block headerCSS %}
	<!-- Load leaflet -->
	<link rel="stylesheet" href="{% static 'leaflet/leaflet.css' %}"/>
{% endblock %}


{% block headerJS %}
    <!-- d3 v3.4.8 -->
    <script src="{% static 'd3/d3.min.js' %}" charset="utf-8"></script>
    
    <!-- Load leaflet -->
    <script src="{% static 'leaflet/leaflet.js' %}"></script>

    <!-- Load marker clustering -->
    <script src="{% static 'leaflet/plugins/leaflet.markercluster/leaflet.markercluster-src.js' %}"></script>

    <!-- Load Maki Markers Icons -->
    <script src="{% static 'leaflet/plugins/maki-markers/Leaflet.MakiMarkers.js' %}"></script>

    <!-- Load heatmap -->
    <script src="{% static 'leaflet/plugins/leaflet-heat/leaflet-heat.js' %}"></script>

    <!-- map generating code -->
    <script src="{% static 'mapApp/js/map.js' %}" charset="utf-8"></script>
{% endblock %}


{% block body %}
	<!-- PLANNED LAYOUT -->
	<!-- Map of one month of reports -->
	

	<!-- Bar graph of Alert area points by type -->
	<!-- See http://bost.ocks.org/mike/bar/ for bar chart tutorials -->
	<svg id="barchart"></svg>
	
	<style>

	#barchart text {
	  fill: white;
	  font: 10px sans-serif;
	  text-anchor: start;
	}

	</style>

	<script>
		// Create dataset out of django context
		// Note, data and counts are for last month of points in user alert areas only, not total points
		var data = [ 
			{ type: "collision", 	value: {{ collisionsCount }}, 	color: "#" + icons["bikeRedIcon"].options.color }, 
			{ type: "nearmiss", 	value: {{ nearmissesCount }}, 	color: "#" + icons["bikeYellowIcon"].options.color }, 
			{ type: "hazard", 		value: {{ hazardsCount }}, 		color: "#" + icons["hazardIcon"].options.color }, 
			{ type: "theft", 		value: {{ theftsCount }}, 		color: "#" + icons["theftIcon"].options.color }
		];

		//make dynamic for screen width
		var height = 400,
			width = 400,
			barWidth = width/data.length;

		var x = d3.scale.linear() // function that translates data to a height value based on the value of d in data
			.domain([0, d3.max(data, function(d) { return d.value; })])
			.range([0, height]);

		// SVG chart elemet
		var chart = d3.select("#barchart")
			.attr("height", height)
			.attr("width", barWidth * data.length);

		// Create a bar for each element in data
		var bar = chart.selectAll("g") // creates d and i. i is the i'th element in data and d is the data at data[i]
			.data(data)
		  .enter().append("g")
		  	.attr("transform", function(d, i) { return "translate(" + i * barWidth + ",0)"; });

			bar.append("rect")
				.attr("y", function(d) { return height - x(d.value); })
				.attr("height", function(d) { return x(d.value); })
				.attr("width", barWidth - 5)
				.attr("fill", function(d) { return d.color; });

			bar.append("text")
				.attr("x", 5)
				.attr("y", height-3)
				// .attr("dy", "1em")
				.text(function(d) { return d.type; });

	</script>


	<!-- Longterm: fancier graphs that monitor change -->

{% endblock %}