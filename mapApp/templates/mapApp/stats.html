{% extends "mapApp/base.html" %}
{% load staticfiles %}


{% block title %}
	Monthly statistics
{% endblock %}


{% block headerCSS %}
	<!-- Load leaflet -->
	<link rel="stylesheet" href="{% static 'leaflet/leaflet.css' %}"/>

	<!-- Barchart style -->
	<link rel="stylesheet" href="{% static 'mapApp/css/barchart.css' %}"/>
{% endblock %}


{% block headerJS %}
    <!-- d3 v3.4.8 -->
    <script src="{% static 'd3/d3.min.js' %}" charset="utf-8"></script>
    
    <!-- Load leaflet -->
    <script src="{% static 'leaflet/leaflet.js' %}"></script>

    <!-- Load marker clustering -->
    <script src="{% static 'leaflet/plugins/leaflet.markercluster/leaflet.markercluster-src.js' %}"></script>

    <!-- Load Maki Markers Icons -->
    <script src="{% static 'leaflet/plugins/maki-markers/Leaflet.MakiMarkers.js' %}"></script>

    <!-- Load heatmap -->
    <script src="{% static 'leaflet/plugins/leaflet-heat/leaflet-heat.js' %}"></script>

    <!-- map generating code -->
    <script src="{% static 'mapApp/js/map.js' %}" charset="utf-8"></script>

    <!-- d3 barchart -->
    <script src="{% static 'mapApp/js/barchart.js' %}" charset="utf-8"></script>
{% endblock %}


{% block body %}

	<style type="text/css">
		#map { 
			height: 100%;
			margin-top: 0px;
		}

	</style>
	

	<div class="container-fluid">
		<div class="row">
			<div class="col-xs-12" style="height: 400px">
				<!-- Map of one month of reports -->
				<div id="map"></div>
			</div>
		</div>
		<div class-"row">	
		<!-- Bar graph of Alert area points by type -->
		<!-- See http://bost.ocks.org/mike/bar/ for bar chart tutorials -->
			<div class="col-xs-6">
				<div class="panel panel-primary">
				  <div class="panel-heading">Monthly totals</div>
				  <div class="panel-body">
					<svg id="barchart" width='100%' height='100%'></svg>
				  </div>
				</div>
			</div>
			<div class="col-xs-6">
				<div class="panel panel-primary">
				  <div class="panel-heading">Trends</div>
				  <div class="panel-body">
				  	<!-- Different chart -->
				  </div>
				</div>
			</div>
		</div>


	</div>

	<script>
	var collisionColor = "#" + icons["bikeRedIcon"].options.color,
		nearmissColor = "#" + icons["bikeYellowIcon"].options.color,
		hazardColor = "#" + icons["hazardIcon"].options.color,
		theftColor = "#" + icons["theftIcon"].options.color

	function setCircleMarker(latlng, typeColor, popupText) {
    	L.circleMarker(latlng, {
        	color: "#000",
        	weight: 2,
        	fillColor: typeColor,
        	fillOpacity: 0.8,
        }).setRadius(3).addTo(map).bindPopup(popupText);
	    heatMap.addLatLng(latlng);
	};

		// Create the map (call to map.js)
        initialize({% if request.mobile %} mobile=true {% endif %});

        // Load user alert areas from the database
        var areasLatLngList = [];
        {% for polygon in geofences %}
            areasLatLngList.push({{ polygon.latlngList }});
            getPolygon( {{ polygon.latlngList }}, {{ polygon.pk }} ); 
        {% endfor %}

   		// Fit map extent to alert areas boundary
        map.fitBounds(L.latLngBounds(areasLatLngList));

        // Load all point data
        {% for theft in recentThefts %}
            setCircleMarker({{theft.latlngList}}, theftColor,
            	'<strong>Theft type:</strong> {{ theft.theft }}<br>'
            	+ '<strong>Date:</strong> {{ theft.theft_date }}'
            );
        {% endfor %}

        {% for hazard in recentHazards %}
            setCircleMarker({{hazard.latlngList}}, hazardColor,
                '<strong>Hazard type:</strong> {{ hazard.hazard }}<br>'
                + '<strong>Date:</strong> {{ hazard.hazard_date }}'
            );
        {% endfor %}

        {% for collision in recentCollisions %}
            setCircleMarker({{collision.latlngList}}, collisionColor, 
                '<strong>Type:</strong> {{ incident.incident }}<br>'
                + '<strong>{% if incident.incident_type != "Fall" %}Incident with'
                + '{% else %}Due to{% endif %}:</strong> {{ incident.incident_with }}<br>'
                + '<strong>Date:</strong> {{ incident.incident_date }}'
            );
        {% endfor %}

        {% for nearmiss in recentNearmisses %}
	        setCircleMarker({{nearmiss.latlngList}}, nearmissColor, 
                '<strong>Type:</strong> {{ incident.incident }}<br>'
                + '<strong>{% if incident.incident_type != "Fall" %}Incident with'
                + '{% else %}Due to{% endif %}:</strong> {{ incident.incident_with }}<br>'
                + '<strong>Date:</strong> {{ incident.incident_date }}'
            );
        {% endfor %}


		// Create dataset out of django context
		// Note, data and counts are for last month of points in user alert areas only, not total points
		var data = [ 
			{ type: "collision", 	value: {{ collisionsCount }}, 	color: collisionColor }, 
			{ type: "nearmiss", 	value: {{ nearmissesCount }}, 	color: nearmissColor }, 
			{ type: "hazard", 		value: {{ hazardsCount }}, 		color: hazardColor }, 
			{ type: "theft", 		value: {{ theftsCount }}, 		color: theftColor }
		];
		initializeBarChart(data);

	</script>


	<!-- Longterm: fancier graphs that monitor change -->

{% endblock %}