{% extends "mapApp/base.html" %}
{% load staticfiles %}


{% block title %}
	Monthly statistics
{% endblock %}


{% block headerCSS %}
	<!-- Load leaflet -->
	<link rel="stylesheet" href="{% static 'leaflet/leaflet.css' %}"/>

	<!-- Barchart style -->
	<link rel="stylesheet" href="{% static 'mapApp/css/barchart.css' %}"/>
{% endblock %}


{% block headerJS %}
    <!-- d3 v3.4.8 -->
    <script src="{% static 'd3/d3.min.js' %}" charset="utf-8"></script>
    
    <!-- Load leaflet -->
    <script src="{% static 'leaflet/leaflet.js' %}"></script>

    <!-- Load marker clustering -->
    <script src="{% static 'leaflet/plugins/leaflet.markercluster/leaflet.markercluster-src.js' %}"></script>

    <!-- Load Maki Markers Icons -->
    <script src="{% static 'leaflet/plugins/maki-markers/Leaflet.MakiMarkers.js' %}"></script>

    <!-- Load heatmap -->
    <script src="{% static 'leaflet/plugins/leaflet-heat/leaflet-heat.js' %}"></script>

    <!-- map generating code -->
    <script src="{% static 'mapApp/js/map.js' %}" charset="utf-8"></script>

    <!-- d3 barchart -->
    <script src="{% static 'mapApp/js/barchart.js' %}" charset="utf-8"></script>
{% endblock %}


{% block body %}

	<style type="text/css">
		#map { 
			height: 100%;
			margin-top: 0px;
		}

	</style>
	

	<div class="container-fluid">
		<div class="row">
			<div class="col-xs-12" style="height: 400px">
				<!-- Map of one month of reports -->
				<div id="map"></div>
			</div>
		</div>
		<div class-"row">	
		<!-- Bar graph of Alert area points by type -->
		<!-- See http://bost.ocks.org/mike/bar/ for bar chart tutorials -->
			<div class="col-xs-6">
				<div class="panel panel-primary">
				  <div class="panel-heading">Monthly totals</div>
				  <div class="panel-body">
					<svg id="barchart" width='100%' height='100%'></svg>
				  </div>
				</div>
			</div>
			<div class="col-xs-6">
				<div class="panel panel-primary">
				  <div class="panel-heading">Trend graph</div>
				  <div class="panel-body">
				  	<!-- Different chart -->
				  </div>
				</div>
			</div>
		</div>


	</div>

	<script>
		function getColor(t){
			if (t == "collision")
				return "#" + icons["bikeRedIcon"].options.color;
			else if (t == "nearmiss")
				return "#" + icons["bikeYellowIcon"].options.color;
			else if (t == "hazard")
				return "#" + icons["hazardIcon"].options.color;
			else if (t == "theft")
				return "#" + icons["theftIcon"].options.color;
			else return "#333";
		}

		// Create the map (call to map.js)
        initialize({% if request.mobile %} mobile=true {% endif %});

        // Load user alert areas from the database
        var areasLatLngList = [];
        {% for polygon in geofences %}
            areasLatLngList.push({{ polygon.latlngList }});
            getPolygon( {{ polygon.latlngList }}, {{ polygon.pk }} ); 
        {% endfor %}

   		// Fit map extent to alert areas boundary
        map.fitBounds(L.latLngBounds(areasLatLngList));




        function geojsonMarkerOptions(type){
        	return {
			    radius: 3,
			    fillColor: getColor(type),
			    color: "#000",
			    weight: 1,
			    opacity: 1,
			    fillOpacity: 0.8
        	}
		};
		{% load geojson_tags %}
        // Load all point data
    	var collisions = L.geoJson({{ recentCollisions|geojsonfeature|safe }}, {
    		pointToLayer: function(feature, latlng){
    			return L.circleMarker(latlng, geojsonMarkerOptions("collision"));
    		},
    	});
    	collisions.addTo(map);

    	var nearmisses = L.geoJson({{ recentNearmisses|geojsonfeature|safe }}, {
    		pointToLayer: function(feature, latlng){
    			return L.circleMarker(latlng, geojsonMarkerOptions("nearmiss"));
    		}
    	});
    	nearmisses.addTo(map);

	    var hazards = L.geoJson({{ recentHazards|geojsonfeature|safe }}, {
    		pointToLayer: function(feature, latlng){
    			return L.circleMarker(latlng, geojsonMarkerOptions("hazard"));
    		}
    	});
    	hazards.addTo(map);

	    var thefts = L.geoJson({{ recentThefts|geojsonfeature|safe }}, {
    		pointToLayer: function(feature, latlng){
    			return L.circleMarker(latlng, geojsonMarkerOptions("theft"));
    		}
    	});
    	thefts.addTo(map);






		// Create dataset out of django context
		// Note, data and counts are for last month of points in user alert areas only, not total points
		var data = [ 
			{ type: "collision", 	value: {{ collisionsCount }}, 	color: getColor("collision") }, 
			{ type: "nearmiss", 	value: {{ nearmissesCount }}, 	color: getColor("nearmiss") }, 
			{ type: "hazard", 		value: {{ hazardsCount }}, 		color: getColor("hazard") }, 
			{ type: "theft", 		value: {{ theftsCount }}, 		color: getColor("theft") }
		];
		initializeBarChart(data);

		// Highlight barchart on mouseover along with corresponding points on map
		$("#barchart rect").mouseenter(function(){
			// show rectangle highlighting
			$(this).attr("stroke-width", "3"); 
			
			// show corresponding highlighted points
			var type = $(this).attr("type");
			console.log(type);
			var layer;
			if(type == "collision") layer = collisions;
			else if(type == "nearmiss") layer = nearmisses;	
			else if(type == "hazard") layer = hazards;	
			else layer = thefts;	
			
			layer.setStyle({
		        fillColor: '#0ff',
		        // radius: 5
		    });

		    if (!L.Browser.ie && !L.Browser.opera) {
		        layer.bringToFront();
		    }
			// show highlighted points on map
		}).mouseleave(function(){
			// Unhighlight rect in char
			$(this).attr("stroke-width", "0");

			// Unhighlight points on map
			var type = $(this).attr("type");
			var layer;
			if(type == "collision") layer = collisions;
			else if(type == "nearmiss") layer = nearmisses;	
			else if(type == "hazard") layer = hazards;	
			else layer = thefts;	
			
			layer.setStyle({
				fillColor: getColor(type),
		        // radius: 5
			});
			
		});
	</script>


	<!-- Longterm: fancier graphs that monitor change -->

{% endblock %}